# MaiMBotå¤šç§Ÿæˆ·é£é™©åˆ†æï¼ˆ2025-12-05ï¼‰

æœ¬ç‰ˆæœ¬ä»…ä¿ç•™ 2025-12-05 çš„æœ€æ–°é£é™©ç ”åˆ¤ï¼Œèšç„¦å½“å‰ä»“åº“çš„é™æ€æ ¸å¯¹ç»“æœã€Todo #6 é£é™©åœ°å›¾ã€æ—§é¡¹ç›® DB é£é™©å¤ç›˜ã€åå°å¼‚æ­¥ä»»åŠ¡ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç¼ºå£ä»¥åŠæ–°å¢æ•´æ”¹å»ºè®®ã€‚

## ğŸ” å››ç§ç§Ÿæˆ·éš”ç¦»æ‰‹æ®µè¯„ä¼°

1. **é…ç½®ä»£ç†ï¼ˆæ¶ˆæ¯å¤„ç†é“¾è·¯å†…çš„ `with TenantContext`ï¼‰**  
    - é€šè¿‡ `GlobalConfigProxy` / `ModelConfigProxy` å°† `__getattr__` å…¨é‡ hookï¼Œé™¤åŸºç¡€ç±»å‹ä»¥å¤–çš„å±æ€§è®¿é—®éƒ½å…ˆæŸ¥ç§Ÿæˆ·é…ç½®ï¼Œå†å›é€€åˆ°é»˜è®¤é…ç½®ã€‚  
    - åœ¨æ¶ˆæ¯å¤„ç† `with tenant_context(chat_id, tenant_id)` ä¸­å¼•ç”¨è¿™äº›ä»£ç†ï¼ŒLLMRequest/manager åˆå§‹åŒ–ä¾æ—§ä½¿ç”¨åŸè·¯å¾„ä½†ä¼šåœ¨è®¿é—®é˜¶æ®µè·å–æ­£ç¡®ç§Ÿæˆ·å€¼ã€‚  
    - é£é™©ï¼šä»æœ‰ 6 ä¸ªåŸºæœ¬ç±»å‹åœ¨ `__init__` é‡Œè¢«å›ºåŒ–ï¼Œéœ€è¦æ‡’åŠ è½½æˆ–å»¶è¿Ÿæ±‚å€¼æ‰èƒ½çœŸæ­£äº«å—ä»£ç†ã€‚

2. **chat_id åŠ ç§Ÿæˆ·å‰ç¼€**  
    - æŠŠæ‰€æœ‰ä»¥ chat_id ä¸º key çš„ç¼“å­˜ã€æ–‡ä»¶ã€ä»»åŠ¡å‘½åç»Ÿä¸€æ”¹æˆ `f"{tenant_id}:{chat_id}"`ï¼Œç¡®ä¿å•ä¸ªç§Ÿæˆ·çš„æ¶ˆæ¯/çŠ¶æ€ä¸ä¼šä¸å…¶ä»–ç§Ÿæˆ·ç¢°æ’ã€‚  
    - é€‚ç”¨æ¨¡å—ï¼šæƒ…ç»ªã€é¢‘æ§ã€Heartflowã€Replyerã€Hippo ç¼“å­˜ã€å…¨å±€å…¬å‘Šç­‰çº¯å†…å­˜/æ–‡ä»¶ç¼“å­˜ã€‚  
    - é£é™©ï¼šChatManager æœ¬ä½“ä»ç”¨ `MD5(platform+group)` ç”Ÿæˆ keyï¼›åœ¨æœªå®ç° `TenantChatManager` å‰ï¼Œä»»ä½•åå°ä»»åŠ¡éƒ½ä¼šè¯»å†™å…±äº«å­—å…¸ã€‚

3. **ORM å±‚è‡ªåŠ¨æ·»åŠ  `tenant_id`**  
    - åœ¨æ¶ˆæ¯ä¸Šä¸‹æ–‡ä¸­è®¾ç½® TenantContext åï¼Œ`TenantModel`/`TenantPeeweeDatabase` èƒ½åœ¨æ¯æ¬¡ `select/update/insert` æ—¶è‡ªåŠ¨é™„å¸¦ `tenant_id`ï¼Œå®ç°â€œåŒè¡¨å¤šç§Ÿâ€ã€‚  
    - ä¸»è¦ä¾èµ–ï¼šæ¨¡å‹è¡¥é½ `tenant_id` å­—æ®µã€ç´¢å¼•ä¸é»˜è®¤å€¼ï¼Œå¹¶ç¡®ä¿è¯·æ±‚/ä»»åŠ¡è¿è¡ŒæœŸé—´ä¸Šä¸‹æ–‡æœªè¢«ä¸­é€”è¦†ç›–ã€‚  
    - é£é™©ï¼šæ‰¹é‡åå°ä»»åŠ¡å¦‚æœåœ¨æ— ä¸Šä¸‹æ–‡ç¯å¢ƒè¿è¡Œï¼ˆå½“å‰å®é™…æƒ…å†µï¼‰ï¼Œä»ä¼šå…¨è¡¨æ‰«æï¼›è€Œæ–‡ä»¶ç³»ç»Ÿ/ç¼“å­˜ä¸€ç±»èµ„æºä¸ ORM æ— å…³ï¼Œä»éœ€å…¶ä»–æ‰‹æ®µã€‚

4. **ï¼ˆæ–°å¢ï¼‰per-tenant AsyncTaskManager**  
    - ä¸ä¿®æ”¹å…·ä½“ä»»åŠ¡é€»è¾‘ï¼Œä»…åœ¨ `AsyncTaskManager` å†…æŠŠæ¯ä¸ªä»»åŠ¡æ‹†æˆâ€œæ¯ç§Ÿæˆ·ä¸€ä¸ªåç¨‹â€ï¼Œé€šè¿‡ `asyncio.gather` å¹¶å‘æ‰§è¡Œï¼Œå¹¶ä¸ºæ¯ä¸ªåç¨‹åŒ…ä¸€å±‚ `async with tenant_context(tenant_id)`ã€‚  
    - ä¼˜ç‚¹ï¼šä»»ä½•å·²ç»è¿ç§»åˆ° `TenantModel` çš„çº¯æ•°æ®åº“å‹ä»»åŠ¡éƒ½èƒ½è‡ªåŠ¨è·å¾—æ­£ç¡®ç§Ÿæˆ·è¿‡æ»¤ï¼Œæ— éœ€è§¦ç¢°ä»»åŠ¡ä»£ç ã€‚  
    - é£é™©ï¼šå¯¹ä»ä¾èµ–å…±äº«ç¼“å­˜/æ–‡ä»¶/å…¨å±€ key çš„ä»»åŠ¡æ— èƒ½ä¸ºåŠ›â€”â€”å¦‚ç»Ÿè®¡ HTMLã€Emoji ç›®å½•ã€å¿ƒè·³ã€ChatManager è‡ªåŠ¨ä¿å­˜ â€”â€” å› ä¸ºè¿™äº›ä»»åŠ¡çš„å‰¯ä½œç”¨å‘ç”Ÿåœ¨ä¸Šä¸‹æ–‡ä¹‹å¤–ã€‚

## ğŸ” å½“å‰ä»“åº“é™æ€æ ¸å¯¹

- **æ€»ä½“ç»“è®º**: ä»£ç ä¸­å°šæœªæ¥å…¥ GlobalConfigProxy / ModelConfigProxyã€ChatStream ç§Ÿæˆ·ä»£ç†ä¸ TenantModelï¼Œç°çŠ¶ä»æ˜¯å•ç§Ÿæˆ·å®ç°ã€‚
- **ä»£è¡¨æ€§é—®é¢˜**:
    - `src/config/config.py` åœ¨å¯¼å…¥é˜¶æ®µå³åŠ è½½é…ç½®ï¼Œä»»ä½•è¯»å–éƒ½ä¼šè¢«å•ä¾‹å›ºåŒ–ã€‚
    - `src/person_info/person_info.py`ã€`src/chat/emoji_system/emoji_manager.py`ã€`src/express/expression_learner.py` åœ¨ `__init__` é˜¶æ®µå›ºåŒ–åŸºæœ¬ç±»å‹å€¼ï¼Œéœ€æ‡’åŠ è½½ã€‚
    - `src/chat/message_receive/chat_stream.py` / `chat_manager.py` ç¼ºå°‘ `TenantChatManager`ï¼Œchat_id ä»æ˜¯å…¨å±€å‘½åç©ºé—´ã€‚
    - `src/common/database/database_model.py` ä¸­ Peewee æ¨¡å‹æ²¡æœ‰ `tenant_id`ï¼Œæ•°æ®åº“è®¿é—®æ— æ³•è‡ªåŠ¨éš”ç¦»ã€‚
- **é¢å¤–é£é™©**:
    - æ’ä»¶é€šè¿‡ `plugin_manager.load_all_plugins()` é™æ€åŠ è½½ï¼Œæ— æ³•æŒ‰ç§Ÿæˆ·åˆ‡æ¢ã€‚
    - LLMRequest ç›´æ¥æŒæœ‰ `model_config` çš„ TaskConfig å®ä¾‹ï¼Œæœªè¢«ä»£ç†æ—¶æ‰€æœ‰ç§Ÿæˆ·å…±ç”¨åŒä¸€ä»½æ¸©åº¦/æœ€å¤§ token ç­‰é…ç½®ã€‚
- **ä¼˜å…ˆçº§å»ºè®®**: å…ˆæ”¹é€  `global_config`/`model_config` ä¸ºä»£ç†å¹¶æ¸…ç† `__init__` å›ºåŒ–ï¼Œå†ç€æ‰‹ ChatStream/æ•°æ®åº“çš„ç§Ÿæˆ·åŒ–ï¼Œå®ç°ä¸Šä¸‹æ¸¸ä¸€è‡´çš„ TenantContextã€‚

## âœ… Todo #6ï¼šå…¨å±€/å•ä¾‹çŠ¶æ€é£é™©åœ°å›¾

ä¸‹è¡¨è®°å½•ä»ä¾èµ– chat_id æˆ–å…¨å±€å•ä¾‹çš„æ¨¡å—ï¼Œå¹¶ç»™å‡ºæ˜¯å¦å¯é€šè¿‡ chat_id å‰ç¼€ã€æ•°æ®åº“ TenantModelã€æˆ–æ›´é«˜å±‚æ”¹é€ æ¥åŒ–è§£é£é™©ã€‚

| æ¨¡å—/æ–‡ä»¶                                                                    | å…±äº«çŠ¶æ€                                                                         | é£é™©                                                                          | åˆ†ç±»     | chat_id åŠ ç§Ÿæˆ·å‰ç¼€                    | DB å±‚ç­–ç•¥ï¼ˆTenantModel / Proxyï¼‰                                                                 | æ¨èç­–ç•¥                                                                                          |
| ---------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- | -------- | ------------------------------------- | ------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------- |
| `src/express/expression_selector.py`                                         | æ¨¡å—çº§å•ä¾‹ `expression_selector`ï¼Œä»…ç¼“å­˜ `LLMRequest`                            | åˆå§‹åŒ–æ—¶è¯»å– `model_config`ï¼Œè‹¥æœªè¢«ä»£ç†åˆ™å›ºåŒ–ä¸ºå•ç§Ÿæˆ·é…ç½®                     | ä»£ç†å¯è§£ | âœ–ï¼ˆé—®é¢˜ä¸ chat_id æ— å…³ï¼‰              | â€”ï¼ˆä»…è¯»é…ç½®ï¼Œä¸è§¦åº“ï¼ŒDB ä»£ç†æ— æ„ä¹‰ï¼‰                                                             | åœ¨åŠ è½½è¯¥æ¨¡å—å‰ç¡®ä¿ `GlobalConfigProxy` / `ModelConfigProxy` å·²æ›¿æ¢åŸå§‹å®ä¾‹                        |
| `src/mood/mood_manager.py`                                                   | å…¨å±€ `mood_manager.mood_list` ä¸ `MoodRegressionTask`                            | æ‰€æœ‰ç§Ÿæˆ·å…±äº« `ChatMood` åˆ—è¡¨ï¼Œæƒ…ç»ª/å›å½’çŠ¶æ€ä¸²æ‰°                               | ç»“æ„æ€§   | âœ…ï¼ˆå‰ç¼€åŒ– stream_id å³å¯éš”ç¦»ï¼‰        | â€”ï¼ˆçº¯å†…å­˜ï¼Œä¸è½åº“ï¼Œæ— æ³•é  DB éš”ç¦»ï¼‰                                                              | å€ŸåŠ© `TenantChatManager` è¾“å‡º `tenant:chat` keyï¼Œå¹¶ä¸º `async_task_manager` æ³¨å…¥ä¸Šä¸‹æ–‡             |
| `src/chat/frequency_control/frequency_control.py`                            | `frequency_control_manager.frequency_control_dict`                               | `talk_frequency_adjust` / `last_frequency_adjust_time` ä»¥ chat_id ä¸º key å¤ç”¨ | ç»“æ„æ€§   | âœ…ï¼ˆkey æ”¹ä¸º `tenant:chat`ï¼‰           | â€”ï¼ˆè®¡æ•°ä¿å­˜åœ¨å†…å­˜ï¼ŒDB ä»£ç†æ¥ä¸ä½ï¼‰                                                               | æ¨å‡º `TenantFrequencyControlManager`ï¼Œæ‰€æœ‰ç¼“å­˜é”®æ·»åŠ ç§Ÿæˆ·å‰ç¼€                                      |
| `src/express/expression_learner.py`                                          | `expression_learner_manager.expression_learners` + `data/expression` ç›®å½•        | å­¦ä¹ ç¼“å­˜ã€é”åŠè½ç›˜æ–‡ä»¶æŒ‰ chat_id å…±äº«ï¼Œæ˜“é€ æˆè·¨ç§Ÿæˆ·å­¦ä¹                        | ç»“æ„æ€§   | âœ…ï¼ˆå†…å­˜/ç›®å½•æŒ‰ `tenant:chat` åŒºåˆ†ï¼‰   | âœ… Expression/ExpressionDraft è¡¨è¿ç§»åˆ° TenantModel åï¼Œä»£ç†å¯è‡ªåŠ¨æ³¨å…¥ tenant_idï¼›ä»éœ€å¤„ç†æ–‡ä»¶ç³»ç»Ÿ | å­—å…¸ã€ç£ç›˜è·¯å¾„æ”¹å‰ç¼€ï¼ŒåŒæ—¶è®© `Expression` ç»§æ‰¿ TenantModel                                        |
| `src/express/expression_reflector.py` & `src/express/reflect_tracker.py`     | `expression_reflector_manager.reflectors`ã€`reflect_tracker_manager.trackers`    | åæ€é¢‘æ§å’Œ Tracker ä»»åŠ¡äº’ç›¸é˜»å¡                                               | ç»“æ„æ€§   | âœ…ï¼ˆkey æ”¹ä¸º `tenant:chat`ï¼‰           | âœ… Expression / Tracker ç›¸å…³è¡¨ä½¿ç”¨ TenantModel åï¼Œä»£ç†å¯è‡ªåŠ¨è¿‡æ»¤ï¼›éœ€ä¸šåŠ¡å±‚ä¼ å…¥ç§Ÿæˆ·ä¸Šä¸‹æ–‡         | ç»Ÿä¸€æ”¹ä¸º (tenant, chat) çº§ç®¡ç†å™¨ï¼Œå¹¶åŒæ­¥æ”¹é€ ç›¸å…³ ORM                                              |
| `src/chat/replyer/replyer_manager.py` & `src/plugin_system/core/tool_use.py` | `replyer_manager._repliers`ã€`ToolExecutor.tool_cache`                           | Replyer/ToolExecutor å¤ç”¨ stream_idï¼Œç¼“å­˜å‘½ä¸­è·¨ç§Ÿæˆ·å¤ç”¨å·¥å…·ç»“æœ               | ç»“æ„æ€§   | âœ…ï¼ˆ`tenant:stream` key å»é™¤ä¸²æ‰°ï¼‰     | â€”ï¼ˆä¸è®¿é—®æ•°æ®åº“ï¼Œä»£ç†æ— ç”¨ï¼‰                                                                      | ä¾èµ– ChatStream ä»£ç†è¾“å‡ºå¸¦ç§Ÿæˆ·çš„ stream_id æˆ–å°è£… `TenantReplyerManager`                          |
| `src/chat/heart_flow/heartflow.py` & `src/chat/brain_chat/brain_chat.py`     | `heartflow.heartflow_chat_list` ç¼“å­˜ `HeartFChatting`/`BrainChatting`            | å¿ƒæµå®ä¾‹å…±äº« mute çŠ¶æ€ã€å¾ªç¯ä¸Šä¸‹æ–‡ï¼Œç§Ÿæˆ·ä¹‹é—´ä¸å¯äº’è§                          | ç»“æ„æ€§   | âœ…ï¼ˆchat_id å‰ç¼€å¯éš”ç¦»å®ä¾‹ç¼“å­˜ï¼‰       | â€”ï¼ˆåªå­˜å†…å­˜ï¼ŒDB æ— æ³•ä»‹å…¥ï¼‰                                                                       | Heartflow é¡¶å±‚æŒ‰ tenant åˆ†æ¡¶ï¼Œå†åœ¨æ¡¶å†…ç¼“å­˜ chat_id                                                |
| `src/hippo_memorizer/chat_history_summarizer.py`                             | `HIPPO_CACHE_DIR/<chat_id>.json`                                                 | ç›¸åŒ chat_id çš„ä¸åŒç§Ÿæˆ·äº’ç›¸è¦†ç›–è¯é¢˜æ‘˜è¦                                       | ç»“æ„æ€§   | âœ…ï¼ˆå‰ç¼€åŒ– chat_id æˆ–ç‹¬ç«‹ç›®å½•ï¼‰        | â€”ï¼ˆå‘½ä¸­æ–‡ä»¶ç³»ç»Ÿï¼ŒDB ä¸å‚ä¸ï¼‰                                                                     | ç¼“å­˜è·¯å¾„æ”¹ä¸º `data/hippo_cache/<tenant>/<chat>.json` æˆ–åŠ è½½æ—¶æ·»åŠ ç§Ÿæˆ·å‰ç¼€                         |
| `src/jargon/jargon_miner.py`                                                 | `JargonMinerManager._miners` + `OrderedDict` ç¼“å­˜                                | é»‘è¯ç¼“å­˜ã€å¼‚æ­¥ä»»åŠ¡ä¸ Peewee æŸ¥è¯¢éƒ½æœªå¸¦ç§Ÿæˆ·                                    | ç»“æ„æ€§   | âœ…ï¼ˆmanager key æ‰©å±•ä¸º `tenant:chat`ï¼‰ | âœ… `Jargon`/`JargonInference` è¿ç§»ä¸º TenantModel åï¼Œä»£ç†å¯æ®ä¸Šä¸‹æ–‡è¿½åŠ  tenant æ¡ä»¶               | ç¼“å­˜ä¸æ•°æ®åº“åŒæ­¥å¼•å…¥ tenant_idï¼Œæ‰€æœ‰æŸ¥è¯¢èµ°ç§Ÿæˆ·ä¸Šä¸‹æ–‡                                              |
| `src/chat/utils/utils_image.py`                                              | `ImageManager` å•ä¾‹ + `data/image`                                               | å›¾ç‰‡/VLM ç¼“å­˜ä¸ `Images` è¡¨å…±ç”¨ç›®å½•/è®°å½•ï¼Œæ˜“ä¸²ç§Ÿæˆ·                            | ç»“æ„æ€§   | âœ–ï¼ˆä¸ä¾èµ– chat_idï¼‰                   | âš ï¸ TenantModel ä»…èƒ½éš”ç¦» ORM è®°å½•ï¼Œæ–‡ä»¶ç³»ç»Ÿä»å…±äº«ï¼›éœ€å’Œç›®å½•æ‹†åˆ†é…åˆ                                | å»ºç«‹ç§Ÿæˆ·æ„ŸçŸ¥çš„ `ImageManager`ï¼Œç›®å½•/ORM å‡å†™å…¥ tenant_id                                          |
| `src/plugin_system/core/global_announcement_manager.py`                      | `_user_disabled_*` å­—å…¸                                                          | æŸç§Ÿæˆ·ç¦ç”¨åŠ¨ä½œå½±å“åŒ chat_id çš„å…¶ä»–ç§Ÿæˆ·                                       | ç»“æ„æ€§   | âœ…ï¼ˆchat_id å‰ç¼€å¯éš”ç¦»ç¦ç”¨åˆ—è¡¨ï¼‰       | â€”ï¼ˆçŠ¶æ€å…¨åœ¨å†…å­˜ï¼ŒDB æœªä»‹å…¥ï¼‰                                                                     | å­—å…¸ key æ‰©å±•ä¸º (tenant, chat)ï¼Œå¿…è¦æ—¶å°†çŠ¶æ€è¿ç§»åˆ°å¸¦ tenant_id çš„è¡¨                               |
| `src/chat/utils/memory_forget_task.py`                                       | å››é˜¶æ®µæ‰¹é‡åˆ é™¤ `ChatHistory`                                                     | å®šæ—¶ä»»åŠ¡éå†æ•´è¡¨ï¼Œæœªé™åˆ¶ç§Ÿæˆ·ï¼Œç›´æ¥æ¸…ç†æ‰€æœ‰è®°å¿†                                | ç»“æ„æ€§   | âœ–ï¼ˆæ•´è¡¨æ‰«æï¼Œå‰ç¼€æ— æ•ˆï¼‰               | âœ… `ChatHistory` å˜ä¸º TenantModel åä»£ç†å¯è‡ªåŠ¨è¿½åŠ ç§Ÿæˆ·è¿‡æ»¤ï¼Œä½†ä»»åŠ¡ä»è¦åœ¨æ‰§è¡Œå‰è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡      | å…ˆä¸º `ChatHistory` æ·»åŠ  tenant_id å¹¶å¼ºåˆ¶ ORM whereï¼Œå†é‡å¯ä»»åŠ¡                                    |
| `src/memory_system/memory_retrieval.py`                                      | `_cleanup_stale_not_found_thinking_back` æ‰¹é‡æ¸…ç† `ThinkingBack`                 | â€œæœªæ‰¾åˆ°ç­”æ¡ˆâ€è®°å½•æŒ‰æ—¶é—´åˆ é™¤ï¼Œæ— ç§Ÿæˆ·æ¡ä»¶                                        | ç»“æ„æ€§   | âœ–ï¼ˆæœªæŒ‰ chat_id æŸ¥è¯¢ï¼‰                | âœ… `ThinkingBack` ä½¿ç”¨ TenantModel åä»£ç†ä¼šè‡ªåŠ¨æ’å…¥ç§Ÿæˆ· whereï¼Œä½†æ¸…ç†è„šæœ¬å¿…é¡»è¿è¡Œåœ¨æ­£ç¡®ä¸Šä¸‹æ–‡     | å°† `ThinkingBack` è¿ç§»åˆ° TenantModelï¼Œå¹¶åœ¨ DB ä»£ç†ä¸­æ³¨å…¥ç§Ÿæˆ·è¿‡æ»¤                                  |
| `src/dream/dream_agent.py`                                                   | å·¥å…· API ç›´æ¥æŒ‰ `id` æ“ä½œ `ChatHistory`                                          | LLM å¯è·¨ç§Ÿæˆ·è¯»å–/ä¿®æ”¹/åˆ é™¤è®°å¿†                                                | ç»“æ„æ€§   | âœ–ï¼ˆæ“ä½œä¸»é”®æ—  chat_idï¼‰               | âœ… éœ€ä¾èµ– TenantModelï¼Œå¦åˆ™ä»£ç†æ— æ³•è¯†åˆ«ç§Ÿæˆ·                                                       | ORM çº§åˆ«å¼ºåˆ¶ç§Ÿæˆ·è¿‡æ»¤ï¼Œå¹¶åœ¨å·¥å…·å±‚æ ¡éªŒ `chat_id` å±äºå½“ç§Ÿæˆ·                                         |
| `src/webui/jargon_routes.py`                                                 | WebUI é»‘è¯ç®¡ç† API æŒ‰ `id` æ“ä½œ                                                  | WebUI å¯è·¨ç§Ÿæˆ·æŸ¥çœ‹/åˆ é™¤/æ›´æ–°é»‘è¯                                              | ç»“æ„æ€§   | âœ–ï¼ˆæ¥å£ä¸ chat_id è„±é’©ï¼‰              | âœ… ä¸€æ—¦ `Jargon` è¡¨æ˜¯ TenantModelï¼ŒDB ä»£ç†å°±èƒ½æ ¹æ®è¯·æ±‚ä¸Šä¸‹æ–‡è¿‡æ»¤ï¼›å…³é”®åœ¨äºè·¯ç”±ä¼ é€’ tenant_id      | WebUI è¯·æ±‚éœ€å¸¦ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œæ‰€æœ‰ ORM æŸ¥è¯¢è¿½åŠ ç§Ÿæˆ·æ¡ä»¶                                               |
| `src/webui/expression_routes.py`                                             | WebUI è¡¨è¾¾ç®¡ç† API                                                               | WebUI æ‰¹é‡æ“ä½œéå†æ•´ä¸ª `Expression` è¡¨                                        | ç»“æ„æ€§   | âœ–ï¼ˆæ¥å£ä»…æŒ‰ id æ“ä½œï¼‰                 | âœ… åŒç†ï¼Œè®© `Expression` ç»§æ‰¿ TenantModel åä»£ç†å¯éš”ç¦»ï¼›éœ€è¦ WebUI å°† tenant_id æ³¨å…¥ ORM          | API å±‚æ ¡éªŒç§Ÿæˆ·ï¼ŒORM è‡ªåŠ¨è¿½åŠ  tenant è¿‡æ»¤                                                          |
| `src/webui/chat_routes.py`                                                   | WebUI èŠå¤©å†å²æŸ¥è¯¢/æ¸…ç©ºä»…æŒ‰ `group_id`                                           | åŒç¾¤å¤šç§Ÿæˆ·æ—¶ä¸€æ¬¡æ¸…ç©ºä¼šåˆ é™¤æ‰€æœ‰ç§Ÿæˆ·è®°å½•                                        | ç»“æ„æ€§   | âœ–ï¼ˆ`group_id`â‰ ç§Ÿæˆ·ï¼‰                  | âœ… `Messages` ç­‰æ¨¡å‹è½¬ TenantModel åä»£ç†èƒ½æ‹¦æˆªï¼Œåªè¦ WebUI è¯·æ±‚è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡                    | WebUI ä¼šè¯åˆ›å»ºæ—¶å†™å…¥ tenant_idï¼Œæ‰€æœ‰æŸ¥è¯¢/æ¸…ç†ä¾èµ– DB ä»£ç†                                         |
| `src/chat/utils/statistic.py`ï¼ˆOnlineTimeRecordTask & StatisticOutputTaskï¼‰  | `OnlineTimeRecordTask.record_id`ã€å…¨å±€ `local_storage`ã€`maibot_statistics.html` | åœ¨çº¿æ—¶é•¿ä¸ç»Ÿè®¡è¾“å‡ºä»»åŠ¡ä¸€æ¬¡æ€§æ±‡æ€»å…¨éƒ¨ç§Ÿæˆ·æ•°æ®                                  | ç»“æ„æ€§   | âœ–ï¼ˆæ—  chat ä¸Šä¸‹æ–‡ï¼‰                   | âš ï¸ å³ä½¿åº•å±‚æ¨¡å‹å·²å¸¦ tenant_idï¼Œä»»åŠ¡åœ¨ AsyncTask ä¸­è¿è¡Œæ—¶æœªè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œä»£ç†æ— æ³•çŸ¥é“å½“å‰ç§Ÿæˆ·    | å°†ç»Ÿè®¡ä»»åŠ¡æ‹†åˆ†ä¸ºâ€œæ¯ç§Ÿæˆ·ä¸€ä»½â€çš„è°ƒåº¦å™¨ï¼Œç‹¬ç«‹å†™å…¥ `maibot_statistics/<tenant>.html` æˆ– API           |
| `src/common/remote.py`ï¼ˆTelemetryHeartBeatTaskï¼‰                             | `local_storage["mmc_uuid"]`ã€ç³»ç»Ÿçº§é¥æµ‹ payload                                  | ä»…ä¸ŠæŠ¥ä¸€ä¸ªå®ä¾‹è§†è§’ï¼Œæ— æ³•ä½“ç°ç§Ÿæˆ·ç²’åº¦ï¼Œå…è®¸è·¨ç§Ÿæˆ·æ³„éœ²éƒ¨ç½²ä¿¡æ¯                  | ç»“æ„æ€§   | âœ–ï¼ˆä¸ chat æ— å…³ï¼‰                     | â€”ï¼ˆä»»åŠ¡å®Œå…¨ä¸è®¿é—® DBï¼Œä»£ç†æ— ä»æ’å…¥ï¼‰                                                             | å®šä¹‰å¹³å°çº§/ç§Ÿæˆ·çº§é¥æµ‹ç­–ç•¥ï¼šè¦ä¹ˆæ˜ç¡®å£°æ˜å…¶ä¸ºâ€œå¹³å°å¿ƒè·³â€ï¼Œè¦ä¹ˆå¤åˆ¶ä¸º per-tenant ä»»åŠ¡                 |
| `src/chat/emoji_system/emoji_manager.py`ï¼ˆå‘¨æœŸæ‰«æï¼‰                         | `emoji_objects` åˆ—è¡¨ã€`data/emoji*` ç›®å½•                                         | å·è¡¨æƒ…/æ¸…ç†ä»»åŠ¡è·¨ç§Ÿæˆ·å…±äº«ç›®å½•ä¸ç¼“å­˜                                           | ç»“æ„æ€§   | âœ–ï¼ˆå…¨å±€ç›®å½•ï¼‰                         | âš ï¸ å³ä¾¿ `Emoji` è¡¨æ”¯æŒ TenantModelï¼Œè¯¥å¾ªç¯ä»ç›´æ¥æ“ä½œç£ç›˜ä¸”æ— ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œä»£ç†å¸®ä¸ä¸Šå¿™              | ä¸ºæ¯ä¸ªç§Ÿæˆ·æ‹†åˆ† `emoji`/`emoji_registered` ç›®å½•ï¼Œå¹¶è®© ORM å¸¦ tenant_id                             |
| `src/chat/message_receive/chat_stream.py`ï¼ˆ`ChatManager._auto_save_task`ï¼‰   | å…¨å±€ `streams`/`last_messages` å­—å…¸ + 5 åˆ†é’Ÿä¸€æ¬¡çš„è‡ªåŠ¨ä¿å­˜å¾ªç¯                   | ç›¸åŒå¹³å°/ç¾¤å·è·¨ç§Ÿæˆ·è¦†ç›–èŠå¤©æµï¼Œä¿å­˜åˆ° `ChatStreams` æ—¶æ— ç§Ÿæˆ·ä¿¡æ¯              | ç»“æ„æ€§   | âš ï¸ éœ€ `TenantChatManager` æ³¨å…¥å‰ç¼€     | âš ï¸ å³ä¾¿ `ChatStreams` æ˜¯ TenantModelï¼Œè¿™ä¸ªåå°ä»»åŠ¡ä»åœ¨â€œæ— ç§Ÿæˆ·ä¸Šä¸‹æ–‡â€é‡Œæ‰¹é‡å†™å…¥ï¼Œä»£ç†ä¸çŸ¥å†™ç»™è°    | å…ˆä¸Š ChatStream ä»£ç†ç”Ÿæˆ `tenant:stream`ï¼Œå†è®© `_auto_save_task` åˆ†ç§Ÿæˆ·å†™å…¥                       |
| `src/manager/async_task_manager.py`ï¼ˆå…¨å±€è°ƒåº¦å™¨ï¼‰                            | æ‰€æœ‰åå°ä»»åŠ¡åœ¨ä¸€ä¸ª `async_task_manager` ä¸­å…±äº«è°ƒåº¦                               | ä»»æ„ AsyncTaskï¼ˆè®°å¿†ã€æ¢¦å¢ƒã€ç»Ÿè®¡ç­‰ï¼‰è„±ç¦»æ¶ˆæ¯ä¸Šä¸‹æ–‡ï¼Œæ— æ³•è·çŸ¥å½“å‰ç§Ÿæˆ·          | ç»“æ„æ€§   | âœ–ï¼ˆä»»åŠ¡çº§åˆ«ï¼‰                         | âš ï¸ å³ä½¿æ¨¡å‹å˜ TenantModelï¼Œè°ƒåº¦å™¨è‹¥ä¸è®¾ç½® `TenantContext`ï¼Œä»£ç†ä»æ‹¿ä¸åˆ° tenant_id                 | æ‰©å±• `AsyncTaskManager`ï¼šæ”¯æŒ per-tenant å®ä¾‹åŒ–ã€æ‰§è¡Œå‰è®¾ç½® `TenantContext`ï¼Œæˆ–ä¸ºä»»åŠ¡æä¾›ç§Ÿæˆ·å¾ªç¯ |

> è¯´æ˜ï¼šâœ… è¡¨ç¤ºè¯¥ç­–ç•¥å³å¯å½»åº•è§£å†³æ­¤è¡Œé£é™©ï¼›âš ï¸ è¡¨ç¤ºä»éœ€é…åˆå…¶å®ƒæ”¹é€ ï¼ˆå¦‚ TenantModelã€ç›®å½•æ‹†åˆ†ã€ä»»åŠ¡ä¸Šä¸‹æ–‡ï¼‰ï¼›âœ– è¡¨ç¤ºè¯¥ç­–ç•¥å¯¹é—®é¢˜æ— å½±å“ï¼›â€œâ€”â€è¡¨ç¤ºä¸é€‚ç”¨ã€‚


### é£é™©å½’ç±»ï¼ˆç»“åˆå››ç§æ‰‹æ®µï¼‰

- **å¯ç”±é…ç½®ä»£ç† + chat_id å‰ç¼€ç›´æ¥åŒ–è§£**ï¼šæƒ…ç»ªã€é¢‘æ§ã€Heartflowã€Replyerã€Hippo æ‘˜è¦ã€å…¬å‘Šç¦ç”¨åˆ—è¡¨ï¼Œåªè¦å…ˆè®© ChatStream ä»£ç†æä¾› `tenant:chat` å¹¶å»¶è¿Ÿè¯»å–é…ç½®å³å¯ã€‚
- **éœ€è¦é…ç½®ä»£ç† + ORM ç§Ÿæˆ·åŒ–**ï¼šè¡¨è¾¾å­¦ä¹ /åæ€ã€é»‘è¯ã€Emoji/å›¾ç‰‡ã€WebUI åå°ã€è®°å¿†/æ¢¦å¢ƒå·¥å…·ï¼Œè¿™äº›æ—¢è¯»é…ç½®åˆå†™æ•°æ®åº“ï¼Œå¿…é¡»åœ¨ TenantModel/ä¸Šä¸‹æ–‡é½å¤‡çš„å‰æä¸‹æ‰èƒ½å®‰å…¨è¿è¡Œã€‚
- **å¿…é¡»å åŠ  per-tenant AsyncTaskManager**ï¼š`MemoryForgetTask`ã€`ThinkingBack` æ¸…ç†ã€`LLMUsage` æ±‡æ€»ç­‰çº¯æ•°æ®åº“åå°ä»»åŠ¡ï¼Œåªæœ‰æ‹†æˆ per-tenant è°ƒç”¨å ORM æ‰èƒ½æ’å…¥ `tenant_id`ã€‚
- **å››ç§æ‰‹æ®µä»æ— è§£ï¼ˆéœ€é¢å¤–æ”¹é€ ï¼‰**ï¼šç»Ÿè®¡/åœ¨çº¿æ—¶é•¿ã€Telemetry å¿ƒè·³ã€Emoji ç›®å½•æ‰«æã€ChatManager è‡ªåŠ¨ä¿å­˜ã€WebUI æ— ç§Ÿæˆ·è·¯ç”±ç­‰ï¼Œå®ƒä»¬è¦ä¹ˆå†™æ–‡ä»¶/ç¼“å­˜ï¼Œè¦ä¹ˆå®šä¹‰ä¸Šæ˜¯å¹³å°çº§æ“ä½œï¼Œå¿…é¡»å…ˆæ”¹ä¸šåŠ¡ç»“æ„ã€‚

> åˆ†ç±»è¯´æ˜ï¼šä»… `expression_selector` è¿™ç±»â€œåªè¯»é…ç½®ä¸”ä¸ç¼“å­˜çŠ¶æ€â€çš„æ¨¡å—å¯ä»¥çº¯é é…ç½®ä»£ç†è§£å†³ï¼Œå…¶ä½™æ¡ç›®éƒ½è¦ä¹ˆéœ€è¦ç§Ÿæˆ·å‰ç¼€ã€è¦ä¹ˆéœ€è¦ TenantModelï¼Œå†æˆ–è€…éœ€è¦é‡å†™ä»»åŠ¡è°ƒåº¦é€»è¾‘ã€‚

## ğŸ“š æ—§é¡¹ç›® DB é£é™©å¤ç›˜

1. **æ¨¡å‹å±‚ä»æ˜¯å•ç§Ÿæˆ· schema**ï¼š`ChatHistory`ã€`ThinkingBack`ã€`LLMUsage`ã€`Messages`ã€`Emoji` ç­‰ Peewee æ¨¡å‹å°šæœªå¢åŠ  `tenant_id` å­—æ®µï¼Œæ‰€æœ‰ WebUI/API/åå°ä»»åŠ¡éƒ½åœ¨æ•´è¡¨æ“ä½œã€‚
2. **åå°ç»´æŠ¤ä»»åŠ¡è·¨è¡¨è¯»å†™**ï¼š`MemoryForgetTask`ã€`run_dream_cycle_once()`ã€ç»Ÿè®¡/åœ¨çº¿æ—¶é•¿ä»»åŠ¡å…¨è¡¨æ‰«æå¹¶æ›´æ–°/åˆ é™¤è®°å½•ï¼Œå³ä¾¿ DB Proxy ä¸Šçº¿ä¹Ÿéœ€è¦æ‰§è¡Œå‰æ˜¾å¼è®¾ç½® `TenantContext`ã€‚
3. **WebUI é‡‡ç”¨å…¨å±€ ID è¯­ä¹‰**ï¼š`jargon_routes`ã€`expression_routes`ã€`chat_routes` ä»…æŒ‰ä¸»é”®æˆ– `group_id` æ“ä½œï¼Œæ— ç§Ÿæˆ·è¿‡æ»¤ï¼Œæœ€å®¹æ˜“è§¦å‘ä¸²ç§Ÿæ“ä½œã€‚
4. **æ–‡ä»¶ç³»ç»Ÿä¸æœ¬åœ°ç¼“å­˜å…±äº«**ï¼š`data/emoji*`ã€`data/image`ã€`HIPPO_CACHE_DIR`ã€`maibot_statistics.html` ç­‰ç›®å½•/æ–‡ä»¶å‡ä¸ºå…¨å±€è·¯å¾„ï¼Œè‹¥ä¸æ‹†åˆ†ç›®å½•å³ä½¿æ•°æ®åº“å¤šç§Ÿæˆ·åŒ–ä»ä¼šç›¸äº’è¦†ç›–ã€‚
5. **Telemetry/ç»Ÿè®¡ç±»ä»»åŠ¡ä¸åˆ†ç§Ÿæˆ·**ï¼š`TelemetryHeartBeatTask`ã€OnlineTime/Statistic ç­‰ä»»åŠ¡ç»´æŠ¤å•ä¸€è§†è§’ï¼Œéœ€è¦æ˜ç¡®å®ƒä»¬æ˜¯å¹³å°çº§å¿ƒè·³è¿˜æ˜¯ per-tenant æŒ‡æ ‡ã€‚

ç»“è®ºï¼šé£é™©æ ¸å¿ƒåœ¨â€œæ¨¡å‹æ—  tenant_id + è¿è¡Œæ—¶ä»»åŠ¡æ— ç§Ÿæˆ·ä¸Šä¸‹æ–‡â€ï¼Œå¤„ç†é¡ºåºåº”ä¸ºï¼šâ‘  æ¨¡å‹è¿ç§»åˆ° TenantModelï¼›â‘¡ AsyncTask/WebUI æ³¨å…¥ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼›â‘¢ æ–‡ä»¶ç³»ç»Ÿä¸ç»Ÿè®¡è¾“å‡ºæ‹†åˆ†è·¯å¾„ã€‚

## â™»ï¸ åå°å¼‚æ­¥ä»»åŠ¡ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç¼ºå£

### âœ… é¢„æœŸè§£å†³æ–¹æ¡ˆï¼šper-tenant AsyncTaskManager

1. **æŒ‰ç§Ÿæˆ·åˆ‡åˆ†ä»»åŠ¡**ï¼šæšä¸¾ç§Ÿæˆ· IDï¼Œé€ä¸ªæ‰§è¡Œ `task.run_for_tenant(tenant_id)`ï¼›é¿å…åŒä¸€æ¬¡ `run()` æ··åˆå¤šä¸ªç§Ÿæˆ·çš„æ•°æ®ã€‚
2. **ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ³¨å…¥ tenant_id**ï¼šé€šè¿‡ contextvar å°è£… `async with tenant_context(tenant_id): ...`ï¼Œè®© ORM/TenantModel è‡ªåŠ¨æ„ŸçŸ¥å½“å‰ç§Ÿæˆ·ï¼›ç¤ºä¾‹ï¼š

```python
@asynccontextmanager
async def tenant_context(tenant_id: str):
    token = TenantContext.set(tenant_id)
    try:
        yield
    finally:
        TenantContext.reset(token)

async def run_for_tenant(task: AsyncTask, tenant_id: str):
    async with tenant_context(tenant_id):
        await task.run()
```

3. **å¹¶å‘è¿è¡Œæ‰€æœ‰ç§Ÿæˆ·**ï¼šåœ¨ Manager ä¸­ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºä¸€ä¸ªåç¨‹å¹¶ `await asyncio.gather(*per_tenant_tasks)`ã€‚Python çš„ contextvars ä¼šä¸ºæ¯ä¸ªåç¨‹ä¿ç•™è‡ªå·±çš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œå› æ­¤æ•°æ®åº“ä»£ç†å¯ä»¥åœ¨æ¯ä¸ªä»»åŠ¡å†…éƒ¨æ³¨å…¥ `tenant_id`ã€‚

è¯¥æ–¹æ¡ˆå¯ç›´æ¥ä¿®å¤â€œçº¯æ•°æ®åº“å‹æ‰¹å¤„ç†ä»»åŠ¡â€ï¼ˆä¾‹å¦‚ `MemoryForgetTask`ã€`ThinkingBack` æ¸…ç†ã€`LLMUsage` å½’æ¡£ç­‰ï¼‰ï¼Œå‰ææ˜¯å¯¹åº” ORM å·²è¿ç§»åˆ° `TenantModel`ï¼Œä¸”ä»»åŠ¡å®ç°ä¸­ä¸å†è®¿é—®å…±äº«ç¼“å­˜/ç£ç›˜ã€‚

### âš ï¸ å¥—ç”¨ä¸Šè¿°æ–¹æ¡ˆåä»å­˜åœ¨é—®é¢˜çš„æ¨¡å—

- **OnlineTimeRecordTask / StatisticOutputTaskï¼ˆ`src/chat/utils/statistic.py`ï¼‰**ï¼šå³ä¾¿æŒ‰ç§Ÿæˆ·è¿è¡Œï¼Œä»ç„¶å†™å…¥åŒä¸€ä¸ª `record_id` ä¸ `maibot_statistics.html`ï¼Œä¼šäº’ç›¸è¦†ç›–ï¼Œå¿…é¡»å…ˆæ‹†åˆ†è¾“å‡ºè·¯å¾„æˆ–æ”¹æˆ APIã€‚
- **TelemetryHeartBeatTaskï¼ˆ`src/common/remote.py`ï¼‰**ï¼šä»»åŠ¡ä¸ä¾èµ– DBï¼Œtenant ä¸Šä¸‹æ–‡æ— ç”¨ï¼›éœ€è¦é‡æ–°å®šä¹‰å¹³å°çº§ vs. ç§Ÿæˆ·çº§å¿ƒè·³é€»è¾‘ã€‚
- **EmojiManager å‘¨æœŸæ‰«æï¼ˆ`src/chat/emoji_system/emoji_manager.py`ï¼‰**ï¼šå¾ªç¯éå†å…¨å±€ `data/emoji*` ç›®å½•å’Œå…±äº« `emoji_objects`ï¼Œå¿…é¡»æ‹†å‡º per-tenant ç›®å½•/ç¼“å­˜åæ‰èƒ½æ³¨å…¥ä¸Šä¸‹æ–‡ã€‚
- **ChatManager `_auto_save_task`ï¼ˆ`src/chat/message_receive/chat_stream.py`ï¼‰**ï¼šå†…å­˜ä¸­çš„ `streams`/`last_messages` ä»æŒ‰ `MD5(platform+group)` å…±äº«ï¼›å¿…é¡»å…ˆä¸Šçº¿ `TenantChatManager`/`ChatStreamProxy`ï¼Œå†æŒ‰ç§Ÿæˆ·åˆ†æ¡¶ä¿å­˜ã€‚
- **Online Emotion / MoodRegressionTaskï¼ˆ`src/mood/mood_manager.py`ï¼‰**ï¼š`mood_list` æ˜¯å…¨å±€ dictï¼Œå“ªæ€•ä¸Šä¸‹æ–‡æ­£ç¡®ä¹Ÿä¼šåœ¨å…±äº«ç¼“å­˜é‡Œè¯»å†™ï¼›éœ€è¦æŠŠ key æ”¹æˆ `(tenant, chat)`ã€‚
- **DreamAgent / è®°å¿†å·¥å…·ï¼ˆ`src/dream/dream_agent.py`ï¼‰**ï¼šå·¥å…· API ä»æŒ‰è®°å½•ä¸»é”®æ“ä½œ `ChatHistory`ï¼Œæ²¡æœ‰ç§Ÿæˆ·çº¦æŸï¼›å¿…é¡»æŠŠæ¥å£æ”¹ä¸º `(tenant_id, chat_id)` å¹¶æ ¡éªŒå½’å±ã€‚
- **WebUI æ‰¹é‡æ“ä½œè·¯ç”±ï¼ˆ`webui/*_routes.py`ï¼‰**ï¼šè·¯ç”±å±‚æœªä¼ ç§Ÿæˆ· IDï¼Œåå°ä»»åŠ¡å³ä½¿æ„ŸçŸ¥ä¸Šä¸‹æ–‡ä¹Ÿæ‹¿ä¸åˆ°æ­£ç¡®ç§Ÿæˆ·ï¼›éœ€è¦åœ¨ HTTP è¯·æ±‚é‡Œä¼ å…¥å¹¶ç»‘å®šç§Ÿæˆ·ã€‚

> ä»¥ä¸Šä»»åŠ¡è¦ä¹ˆä¾èµ–å…¨å±€ç¼“å­˜/æ–‡ä»¶ï¼Œè¦ä¹ˆå®šä¹‰ä¸Šå°±æ˜¯å¹³å°çº§æ“ä½œï¼Œå•é  AsyncTaskManager æ³¨å…¥ä¸Šä¸‹æ–‡æ— æ³•å½»åº•éš”ç¦»ï¼Œä»éœ€å¯¹åº”æ¨¡å—å®Œæˆç¼“å­˜åˆ†æ¡¶ã€ç›®å½•æ‹†åˆ†æˆ–æ¥å£æ”¹é€ ã€‚

## ğŸ› ï¸ Todo #7ï¼šæ–°å¢æ•´æ”¹å»ºè®®

- **æƒ…ç»ª / é¢‘æ§ / è§„åˆ’é“¾è·¯**ï¼šå…ˆå®Œæˆ `TenantContext` æ³¨å…¥æˆ– ChatStream ä»£ç†ï¼Œå†è®© `MoodManager`ã€`FrequencyControlManager`ã€`ReplyerManager`ã€Heartflow ç­‰é€šè¿‡ `(tenant_id, chat_id)` ç®¡ç†ç¼“å­˜ã€‚
- **å­¦ä¹  / åæ€ / é»‘è¯é“¾è·¯**ï¼š`ExpressionLearner`ã€`ExpressionReflector`ã€`ReflectTracker`ã€`JargonMiner` éœ€è¦åœ¨å†…å­˜ã€ç£ç›˜å’Œ ORM ä¸‰å±‚åŒæ—¶å†™å…¥ tenant_idï¼Œå¹¶æŠŠå¼‚æ­¥ä»»åŠ¡è°ƒåº¦ç²’åº¦åˆ‡åˆ°ç§Ÿæˆ·çº§ã€‚
- **ç¼“å­˜ä¸ç£ç›˜**ï¼š`ChatHistorySummarizer`ã€`ImageManager` ç­‰æ‰€æœ‰è½ç›˜è·¯å¾„éœ€åŠ å…¥ tenant_idï¼Œç­‰å¾…æ•°æ®åº“ TenantModel æ”¹é€ å®Œæˆåç»Ÿä¸€è¿ç§»ã€‚
- **æ’ä»¶æ§åˆ¶é¢**ï¼š`global_announcement_manager`ã€`ToolExecutor` ç¼“å­˜ä¾èµ– stream_idï¼ŒChatStream ä»£ç†ä¸Šçº¿æ—¶ç»Ÿä¸€åˆ‡æ¢åˆ° `tenant:stream` å‘½åå¹¶æ¸…ç†æ—§ç¼“å­˜ã€‚
- **éªŒè¯é¡ºåº**ï¼šå…ˆå®Œæˆ `TenantContext` + é…ç½®ä»£ç†åˆå§‹åŒ–ï¼Œå†é€ä¸ªè¿ç§»ç®¡ç†å™¨ä¸æ•°æ®åº“ï¼Œæœ€åå¤„ç†æ’ä»¶ä¸ç»Ÿè®¡/æ–‡ä»¶ç³»ç»Ÿçš„é•¿å°¾é—®é¢˜ã€‚

## âœ… ä¸‹ä¸€æ­¥éªŒè¯å»ºè®®

- åœ¨ `global_config`ã€`model_config`ã€`TenantContext` ä¸Šå®ç°ä»£ç†åï¼Œå†æ¬¡é€é¡¹è·‘é€šè¡¨æ ¼ä¸­çš„æ¨¡å—ï¼Œç¡®è®¤ç¼“å­˜/ä»»åŠ¡æ˜¯å¦å·²ç»è·å¾—ç§Ÿæˆ·ä¸Šä¸‹æ–‡ã€‚
- å¯¹ `ChatHistory`ã€`ThinkingBack`ã€`LLMUsage`ã€`Messages`ã€`Emoji` ç­‰æ ¸å¿ƒæ¨¡å‹å…ˆè¡Œæ·»åŠ  `tenant_id` å­—æ®µåŠç´¢å¼•ï¼Œå†ä¸º WebUI/API æ³¨å…¥ç§Ÿæˆ·è¿‡æ»¤ã€‚
- å»ºç«‹ per-tenant AsyncTask è°ƒåº¦æ¡†æ¶ï¼Œè®© OnlineTimeã€Statisticã€è®°å¿†æ¸…ç†ã€æ¢¦å¢ƒå¾ªç¯ç­‰ä»»åŠ¡éƒ½èƒ½å¸¦ç€ç§Ÿæˆ·èº«ä»½è¿è¡Œã€‚
- é€æ­¥æ‹†åˆ† `data/emoji*`ã€`data/image`ã€`HIPPO_CACHE_DIR`ã€`maibot_statistics.html` ç­‰ç£ç›˜è·¯å¾„ï¼Œé¿å… DB å±‚æ”¹é€ å®Œæˆåä»ç”±æ–‡ä»¶è¦†ç›–é€ æˆä¸²ç§Ÿã€‚

> æœ¬æ–‡æ¡£å°†æŒç»­åªä¿ç•™æœ€æ–°åˆ†æç»“æœï¼Œåç»­è‹¥æœ‰æ–°å¢é£é™©æˆ–æ•´æ”¹éªŒè¯ï¼Œè¯·ç›´æ¥åœ¨å¯¹åº”ç« èŠ‚æ›´æ–°ã€‚

## ğŸ§¾ ç»“è®ºå›é¡¾

- **é…ç½®ä»£ç†** è§£å†³â€œè¯»é…ç½®â€ç±»å›ºåŒ–ï¼ˆé™¤ä»éœ€æ‡’åŠ è½½çš„ 6 ä¸ªåŸºç¡€ç±»å‹ï¼‰ï¼Œæ˜¯æ‰€æœ‰æ‰‹æ®µçš„å‰ç½®æ¡ä»¶ã€‚
- **chat_id å‰ç¼€** è´Ÿè´£å…œä½å†…å­˜/ç¼“å­˜/æ–‡ä»¶è·¯å¾„ï¼Œåªè¦ ChatStream/manager èƒ½å¯¼å‡º `tenant:chat`ï¼Œå¤§éƒ¨åˆ†è¿è¡Œæ€çŠ¶æ€å³å¯éš”ç¦»ã€‚
- **ORM ç§Ÿæˆ·åŒ–** è®©æ•°æ®åº“å±‚è‡ªåŠ¨è¿½åŠ  `tenant_id`ï¼Œä½†å‰ææ˜¯è°ƒç”¨å‘ç”Ÿåœ¨æ­£ç¡®çš„ `TenantContext` ä¸­ï¼›ä¸ per-tenant AsyncTaskManager è”åŠ¨åï¼Œæ‰¹é‡ä»»åŠ¡æ‰èƒ½çœŸæ­£è¢«éš”ç¦»ã€‚
- **per-tenant AsyncTaskManager** æ˜¯å½“å‰æ–°å¢æ‰‹æ®µï¼Œç”¨äºâ€œåªæ”¹è°ƒåº¦å™¨å°±èƒ½æŠŠä»»åŠ¡æ‹†ç§Ÿæˆ·â€çš„åœºæ™¯ï¼›å®ƒæ— æ³•è§£å†³ä»ä¾èµ–å…±äº«ç¼“å­˜æˆ–å¹³å°çº§è¾“å‡ºçš„ä»»åŠ¡ï¼Œå› æ­¤è¿™äº›æ¨¡å—ä»åˆ—å…¥é£é™©æ¸…å•ï¼Œéœ€è¦æ¶æ„å±‚æ”¹é€ ã€‚