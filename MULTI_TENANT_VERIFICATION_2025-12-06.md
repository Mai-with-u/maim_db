# MaiMBot 多租户改造核验（2025-12-06）

## 背景
- 目标：核实 `MULTI_TENANT_MIGRATION_STRATEGY.md` 中提出的四项手段是否已经真正落地，并复核 Todo #6 风险地图里的模块。
- 仓库：`MaiMBot`（运行时）与 `maim_db`（统一 DB 层）。检查基于 `master` 当前工作副本。

## 现状总结（2025-12-06 代码核查）
### 已完成的隔离/上下文改造
- **Chat stream ID 前缀**：`src/chat/message_receive/chat_stream.py` 通过 `_hash_components` 统一在 MD5 前拼接 `tenant_id/agent_id`，并在缺少上下文时抛出 `RuntimeError`，`group_generator.py`/`private_generator.py` 也改为复用该 helper，确保 chat_id 的租户唯一性。
- **API 消息入口注入上下文**：`src/common/message/api.py:message_handler` 在解析 API Key 成功后会 `async with tenant_context_async(tenant_id, agent_id)` 再调用旧链路，并把标识写入 `message_info.additional_config` 与活跃上报，保证配置代理和 TenantModel 在 API Server 场景下可用。
- **配置代理钩子仍有效**：`global_config` / `model_config` 依旧通过 `_RuntimeAwareConfig`/`_RuntimeAwareAPIAdapterConfig` 包装（`src/config/config.py` 605 行起），所有非基础类型属性访问都会根据当前上下文查询 `_TenantConfigProvider` 的缓存，现阶段未发现新的直读配置绕过。

### 仍未解决/需要优先关注的隔离风险
- **情绪与频控缓存共享**：`src/mood/mood_manager.py` 的 `MoodManager.mood_list` 以及 `src/chat/frequency_control/frequency_control.py` 的 `frequency_control_dict` 依旧以裸 `chat_id` 为 key，`MoodRegressionTask`/`FrequencyControl.trigger_frequency_adjust` 均在无租户上下文的后台任务里运行，容易跨租户串情绪/频率。
- **表达学习/选择链路**：`src/express/expression_learner.py`、`expression_selector.py` 在模块导入时即实例化 `LLMRequest` 并直接读取 `global_config`，且 `_parse_stream_config_to_chat_id` 仍用旧的 MD5 平台 hash，未感知租户；学习产物落盘到 `data/expression` 并写入 `Expression` 表时也没有传入 `tenant_id`。
- **全局禁用控制面**：`src/plugin_system/core/global_announcement_manager.py` 里的 `_user_disabled_*` 字典继续只以 `chat_id` 为键，任一租户禁用动作都会影响相同 chat_id 的其他租户。
- **其他后台/工具模块**：`Heartflow`、`Hippo` 摘要、`ImageManager`、WebUI 路由、`memory_forget_task` 等在策略文档里列出的模块尚未改动，仍然缺失 `(tenant, chat)` namespacing 或 TenantModel 字段，文件/缓存依旧是共享目录，需要按照风险表持续整改。

## 1. 四大策略落实情况
| 策略                                             | 预期                                                                                     | 观察到的现状（2025-12-06）                                                                                                                                                                                                                                                                                                                                                                                        | 结论                             |
| ------------------------------------------------ | ---------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------- |
| 配置代理（GlobalConfigProxy / ModelConfigProxy） | `global_config` / `model_config` 在访问时通过租户上下文解析；模块不再在导入时固化配置。  | `src/config/config.py` 仍按 `_RuntimeAwareConfig`/`_RuntimeAwareAPIAdapterConfig` 注入代理，并要求 `tenant_context` 提供 `(tenant_id, agent_id)`；`src/common/message/api.py:message_handler` 现已在解析出 API Key → tenant/agent 后进入 `tenant_context_async` 再调用原处理流程，但 WebUI、测试脚本等入口依旧没有上下文，仍然可能触发“Missing tenant_id or agent_id” 异常。                                      | **实现但受限于上下文覆盖面**     |
| chat_id 加租户前缀（TenantChatManager）          | 所有缓存/文件命名改为 `tenant:chat` 或分租户目录。                                       | `ChatManager` 现已在 `_hash_components` 中强制读取 `tenant_id/agent_id` 并把它们拼接进哈希（`MaiMBot/src/chat/message_receive/chat_stream.py` 133-164 行），旧入口在缺少上下文时会直接抛出 `RuntimeError`。但 `mood_manager` / `frequency_control_manager` 等缓存 dict 仍只使用聊天哈希，不会额外附带租户字段，文件/缓存命名也尚未拆分目录。                                                                      | **核心入口已实现，周边缓存未改** |
| ORM 层自动添加 tenant_id（TenantModel）          | Peewee 模型统一继承带 `tenant_id` 的 BaseModel，且在请求/任务入口设置 `tenant_context`。 | `MaiMBot/src/common/database/database_model.py` 的 BaseModel 仍要求上下文自动填充 `tenant_id`；现在 `message_handler` 会在拿到 API Key 解析结果后通过 `tenant_context_async` 包裹 `handler.message_process`，因此经 API-Server 进入的消息在多数分支上具备上下文。但 WebUI/HTTP 路由、离线脚本与 DB 迁移仍未提供 `tenant_id` 字段，`ChatStreams.replace(...)` 等写操作只要脱离消息链路仍会因 `_require_ids` 抛错。 | **实现但仅限 API 链路可用**      |
| per-tenant AsyncTaskManager                      | 调度器为每个活跃租户/Agent 启动协程并在 `tenant_context` 下执行。                        | `src/manager/async_task_manager.py` 继续以 `per_tenant=True` 为默认并依赖 `AsyncAgentActiveState.list_active()`，`message_handler` 现在会在入站消息成功解析后调用 `upsert_active_from_message` 并设置上下文，因此后台任务能拿到更多活跃记录。但大量任务内部仍按全局缓存/文件操作，没有 `(tenant, chat)` 维度，导致即使 per-tenant 调度也会串租。                                                                  | **部分落地，缓存/存储仍未隔离**  |

> 附注：全仓搜索 `tenant_context(` / `tenant_context_async(` 现新增 `src/common/message/api.py:message_handler` 的包裹，但 WebUI 路由、定时脚本和大部分后台任务仍未显式设置上下文。

## 2. 风险地图复核结果
| 风险条目（来自 Todo #6）                                                     | 期望的缓解措施                                           | 当前代码状态                                                                                                                                                                                                               | 证据                                                                   |
| ---------------------------------------------------------------------------- | -------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `src/express/expression_selector.py`                                         | 依赖配置代理或懒加载，避免初始化固化。                   | 模块导入时就实例化 `LLMRequest` 并直接引用 `global_config`。                                                                                                                                                               | `MaiMBot/src/express/expression_selector.py` 14-52 行                  |
| `src/mood/mood_manager.py`                                                   | `TenantChatManager` + `(tenant, chat)` 缓存 Key。        | `MoodManager.mood_list` 是全局 list，仅按 `chat_id` 维护；后台任务默认 `per_tenant=True` 但 `run_for` 中无租户上下文。                                                                                                     | `MaiMBot/src/mood/mood_manager.py` 93-160 行                           |
| `src/chat/frequency_control/frequency_control.py`                            | 缓存 key 加租户前缀。                                    | `FrequencyControlManager.frequency_control_dict` 的 key 仍是 chat_id；没有引用租户。                                                                                                                                       | 同文件 121-170 行                                                      |
| `src/express/expression_learner.py`                                          | 内存/磁盘/ORM 同步写 tenant。                            | Learner 的锁、时间戳、数据库访问和磁盘输出全部以 `chat_id` 为粒度；未拆租户目录。                                                                                                                                          | 文件 1-120 行                                                          |
| `src/express/expression_reflector.py` & `reflect_tracker.py`                 | 管理器 key 使用 `(tenant, chat)` 并依赖 TenantModel。    | `ExpressionReflectorManager.reflectors: Dict[str, ExpressionReflector]` 与 `ReflectTrackerManager.trackers` 均为 chat_id -> 实例；SQL 查询未附带租户条件。                                                                 | `expression_reflector.py` 136-171 行；`reflect_tracker.py` 155-189 行  |
| `src/chat/replyer/replyer_manager.py` & `src/plugin_system/core/tool_use.py` | ChatStream 产出租户前缀 stream_id 或重写 Manager。       | Replyer 缓存与 ToolExecutor 的 `tool_cache` / `global_announcement_manager` 均只用 chat_id，`global_announcement_manager` 里 `_user_disabled_*` 仍是 `Dict[str, List[str]]`。                                              | `replyer_manager.py` 9-56 行；`global_announcement_manager.py` 9-63 行 |
| `src/chat/heart_flow/heartflow.py` & `src/chat/brain_chat/brain_chat.py`     | Heartflow 顶层按租户分桶。                               | `Heartflow.heartflow_chat_list` 是单全局 dict，key=chat_id。                                                                                                                                                               | `heartflow.py` 15-36 行                                                |
| `src/hippo_memorizer/chat_history_summarizer.py`                             | `HIPPO_CACHE_DIR` 拆分/前缀化。                          | `HIPPO_CACHE_DIR` 固定为 `data/hippo_memorizer`，缓存文件命名为 `<chat_id>.json`。                                                                                                                                         | 文件 19-78 行                                                          |
| `src/jargon/jargon_miner.py`                                                 | 管理器及 ORM 引入 tenant_id。                            | `JargonMiner.cache`、数据库查询与任务触发均只基于 chat_id；`Jargon` 模型无 tenant 字段。                                                                                                                                   | 文件 1-120 行                                                          |
| `src/chat/utils/utils_image.py`                                              | `ImageManager`/`Images` 表携带 tenant 信息，磁盘分目录。 | `ImageManager.IMAGE_DIR = "data"`，所有租户共用目录；数据库模型缺少 tenant_id。                                                                                                                                            | 文件 18-70 行                                                          |
| `src/plugin_system/core/global_announcement_manager.py`                      | key = `(tenant, chat)` 或迁移至 DB。                     | `_user_disabled_*` 字典 key = chat_id，租户共享禁用状态。                                                                                                                                                                  | 文件 8-60 行                                                           |
| `src/chat/utils/memory_forget_task.py`                                       | 任务须在 `tenant_context` 内并限制 Query。               | `ChatHistory.select()`/`delete()` 无任何租户过滤，任务继承 `AsyncTask` 但 `run()` 中直接访问全表。                                                                                                                         | 文件 32-126 行                                                         |
| `src/memory_system/memory_retrieval.py`                                      | `ThinkingBack` 继承 TenantModel 且清理任务 per-tenant。  | `_cleanup_stale_not_found_thinking_back` 直接删除所有租户的记录，任务无上下文。                                                                                                                                            | 文件 1-60 行                                                           |
| `src/dream/dream_agent.py`                                                   | 工具 API 必须校验 `(tenant_id, chat_id)`。               | Dream 工具按 chat_id/record id 直接操作 `ChatHistory`，无租户隔离。                                                                                                                                                        | 文件 1-160 行                                                          |
| `src/webui/jargon_routes.py`                                                 | HTTP 请求需附带租户 + ORM 自动过滤。                     | WebUI 接口按主键或 `chat_id` 查询/删除，无租户约束。                                                                                                                                                                       | 文件 1-140 行                                                          |
| `src/webui/expression_routes.py`                                             | 同上。                                                   | 仍以 `id`/`chat_id` 为参数，整表遍历。                                                                                                                                                                                     | 同文件 1-120 行                                                        |
| `src/webui/chat_routes.py`                                                   | 清空/查询按租户分区。                                    | 路由参数只有 `group_id` 或 `stream_id`，执行时 `Messages.delete()` 不带租户条件。                                                                                                                                          | 文件 1-110 行                                                          |
| `src/chat/utils/statistic.py`（OnlineTimeRecordTask & StatisticOutputTask）  | 输出拆分为 per-tenant 文件或 API。                       | 仍写入单一 `maibot_statistics.html` 和 `local_storage`，统计累计所有租户。                                                                                                                                                 | 文件 1-180 行                                                          |
| `src/common/remote.py`（TelemetryHeartBeatTask）                             | 区分平台心跳 vs 租户心跳。                               | 任务向全局 `TELEMETRY_SERVER_URL` 上报单一 `mmc_uuid`，payload 不含租户字段。                                                                                                                                              | 文件 1-130 行                                                          |
| `src/chat/emoji_system/emoji_manager.py`                                     | 每个租户独立 `emoji/emoji_registered` 目录。             | `EMOJI_DIR = data/emoji`，扫描/清理/盗表情任务共享目录与 `emoji_objects`。                                                                                                                                                 | 文件 20-70、298-360 行                                                 |
| `src/chat/message_receive/chat_stream.py` `_auto_save_task`                  | 需先引入 `TenantChatManager` 生成 `tenant:stream`。      | ChatManager 现在通过 `_hash_components` 将 `tenant_id/agent_id` 注入 `stream_id`，无上下文时直接报错；但 `streams`/`last_messages` 依旧是单层 dict，自动保存任务只要恢复就会在全局作用域内遍历所有租户的记录。             | 文件 84-210 行                                                         |
| `src/manager/async_task_manager.py`                                          | 任务运行前必须获取活跃租户上下文。                       | `AsyncTask.run_for` 会进入 `tenant_context_async`，且消息入口现在会在成功解析 API Key 后 `upsert_active_from_message`，因此 per-tenant 任务能拿到更多上下文；但任务实现本身仍直接操作全局缓存/文件，无法真正隔离租户数据。 | 文件 1-140 行                                                          |

## 3. 建议的后续动作
1. **先补齐基础能力**：运行时配置代理依旧需要上下文，虽然 API-Server 入站消息已在 handler 中设置 `tenant_context_async`，但 WebUI、命令行脚本和后台任务入口仍未建立上下文；仍需同步落地 `TenantChatManager`、`TenantModel` schema 迁移，并在所有入口显式设置 `tenant_context` 以解锁代理的价值。
2. **执行数据库迁移 & 回填**：为 `ChatStreams`, `Messages`, `ChatHistory`, `ThinkingBack`, `LLMUsage`, `Emoji`, `Expression`, `Jargon` 等核心表添加 `tenant_id` 字段与索引，并规划历史数据 owner/回填策略。
3. **缓存/文件分桶**：按照风险表优先级对情绪/频控/Heartflow/Replyer、Hippo cache、emoji/image/统计输出等共享状态做命名空间拆分。没有租户目录的任务即使在 per-tenant 调度下也会串租。
4. **按租户调度后台任务**：在 `AsyncTask` 子类的入口显式读取 `tenant_id` 并把它传播到 DB/API 层，禁止“未找到活跃租户时回退为全局执行”。同时梳理任务副作用（如 `local_storage`、HTML 输出），拆分为 per-tenant 资源。
5. **WebUI/HTTP 层补充租户参数与鉴权**：所有路由需从 API Key 或请求头解析 `tenant_id`，进入 ORM 前调用 `tenant_context` 或显式 where 过滤。
6. **验证链路**：为每个模块建立“同群不同租户”测试用例，确保缓存、文件和数据库写入不会互相覆盖。

> 本报告聚焦代码层静态核查；未覆盖尚未提交的配置、部署脚本或运行时环境。如果需要进一步的迁移计划/验收 checklist，可在上述基础能力就绪后再生成新版本。
